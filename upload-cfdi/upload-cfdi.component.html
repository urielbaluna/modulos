<!-- Contenido principal -->
<div class="flex flex-col items-center bg-white w-full h-[90%] shadow-md overflow-hidden">
    <div class="bg-[#E6E5E5] w-full">
        <p class="text-[#0E9B86] text-center text-2xl font-bold py-2">Alta de CFDI</p>
    </div>
    <div class="p-6 flex items-center gap-2 w-full justify-center">
        <div class="relative w-full">
            <input type="text"
                placeholder="Buscar..."
                class="border rounded-md text-sm w-full text-[#005F6E] pr-10"
                [(ngModel)]="searchText"
                id="searchInput"
                (keyup.enter)="isValidSearch(searchText) && consultarCartas()"
            >
            <button 
                *ngIf="searchText"
                type="button"
                class="absolute inset-y-0 right-0 flex items-center pr-3 focus:outline-none"
                (click)="searchText=''"
                tabindex="-1"
            >
                <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <button
            title="Buscar"
            (click)="isValidSearch(searchText) && consultarCartas()"
            class="bg-[#383A6B] text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400"
        >
            <i class="bx bx-search text-lg"></i>
        </button>
    </div>
    <div class="relative group flex items-center justify-between px-6 pb-2 w-full">
        <p class="text-sm text-[#0E9B86] font-bold">
            Total de registros: {{ getTotalRegistros() }}
        </p>
        <button 
            class="bg-[#383A6B] text-white rounded-sm shadow hover:bg-purple-700"
            (click)="showColumnMenu = !showColumnMenu"
        >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="w-5 h-5">
                <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                <line x1="9" y1="4" x2="9" y2="20"></line>
                <line x1="15" y1="4" x2="15" y2="20"></line>
            </svg>
        </button>
    </div>
    <div class="overflow-x-auto px-6 pb-2 w-full">
        <div
            *ngIf="getTotalRegistros() === 0" 
            class="flex items-center justify-center text-gray-400 py-10">
            <i class="bx bxs-error-circle text-xl mr-2"></i>
            <p class="text-2xl">Realiza una consulta para dar de alta reportes de CFDI.</p>
        </div>
        <div *ngIf="getTotalRegistros() >= 1" class="max-h-[98%] overflow-scroll">
            <table
            class="w-full border-collapse rounded-lg overflow-hidden overflow-y-auto">
                <thead class="bg-gray-200 text-sm text-gray-700">
                    <tr>
                        <th *ngFor="let col of columnas"
                        class="px-3 py-2 text-left cursor-pointer select-none sticky top-0 z-10 bg-gray-200"
                        [hidden]="!col.visible"
                        (click)="sortByColumn(col)">
                        {{ col.label }}
                            <span *ngIf="sortColumn === col.field">
                                <svg *ngIf="sortDirection === 'asc'" class="inline w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"></path></svg>
                                <svg *ngIf="sortDirection === 'desc'" class="inline w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg>
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr
                    *ngFor="let row of filteredData"
                    class="border-b hover:bg-[#E6E5E5] transition-colors"
                    >
                        <td
                        *ngFor="let col of columnas"
                        class="px-3 py-2 whitespace-nowrap"
                        [ngClass]="{
                            'text-right': col.field === 'fiTarifa'
                        }"
                        [hidden]="!col.visible">
                            <ng-container *ngIf="col.field === 'fiTarifa'; else normalCell">
                                {{ row[col.field] | currency:'':'symbol':'1.0-2' }}
                            </ng-container>
                            <ng-template #normalCell>
                                {{ row[col.field] }}
                            </ng-template>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="grid grid-cols-4 gap-4 px-6 w-full mt-auto"
        *ngIf="getTotalRegistros() > 0"
    >
        <div class="flex flex-col gap-4">
            <div class="mb-2 h-8">
                <span class="font-bold ">
                    No. de ODC:
                </span>
            </div>
            <div class="mb-2 h-8">
                <span class="text-[#E57373] font-bold ">
                    Fecha de emisión:
                </span>
            </div>
            <div class="mb-2 h-8">
                <span class="text-[#E57373] font-bold">
                    Documento respaldo:
                </span>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <div class="mb-2 h-8">
                <input type="number" 
                class="border-2 border-[#017D91] rounded w-full px-2 py-1 hover:ring-2 hover:border-[#017D91] focus:ring-2 focus:border-[#017D91]"
                [(ngModel)]="fiOrdenServicio">
            </div>
            <input
                type="date"
                class="border-2 border-[#017D91] rounded w-full px-2 py-1 focus:ring-2 focus:border-[#017D91] h-8 mb-2 hover:ring-2 hover:border-[#017D91]"
                placeholder="Selecciona fecha"
                [(ngModel)]="fdFechaCfdi"
            />
            <div class="mb-2">
                <div class="flex items-center gap-2">
                    <label class="bg-[#005F6E] text-white rounded-md py-2 px-6 hover:bg-[#004C58] cursor-pointer flex items-center  w-full">
                        <span class="mr-2 font-bold text-base">+</span> Selecciona archivo
                        <input type="file" class="hidden" (change)="onFileSelected($event)" />
                    </label>
                </div>
                <div class="flex items-center gap-2 h-8"
                    *ngIf="selectedFileName">
                    <span class="text-gray-500 text-xs flex items-center h-8 truncate overflow-hidden whitespace-nowrap w-full">
                        {{ selectedFileName || 'No hay archivo seleccionado.' }}
                    </span>
                    <button type="button" class="flex items-center justify-center h-8" (click)="removeFile()">
                        <svg class="w-5 h-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <div class="mb-2 h-8">
                <span class="text-[#E57373] font-bold ">
                    No. de CFDI:
                </span>
            </div>
            <div class="mb-2 h-8">
                <span class="text-[#E57373] font-bold ">
                    Monto CFDI:
                </span>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <div class="mb-2 h-8">
                <input type="text" 
                    class="border-2 border-[#017D91] rounded w-full px-2 py-1 hover:ring-2 hover:border-[#017D91] focus:ring-2 focus:border-[#017D91]"
                    [(ngModel)]="fcCfdi">
            </div>
            <div class="mb-2 h-8">
                <input type="number" 
                    class="border-2 border-[#017D91] rounded w-full px-2 py-1 hover:ring-2 hover:border-[#017D91] focus:ring-2 focus:border-[#017D91]"
                    [(ngModel)]="fiMontoPago">
            </div>
                <button
                    class="bg-[#005F6E] text-white rounded-md py-2 px-6 hover:bg-[#004C58] mb-1 mt-auto"
                    (click)="updateCFDI()"
                    >
                    Guardar
                </button>
            </div>
        </div>
</div>

<!-- Menú de selección de columnas -->
<div 
    *ngIf="showColumnMenu"
    class="fixed top-20 right-10 w-64 bg-white border rounded-lg shadow-lg z-50 p-4"
>
    <h3 class="font-bold mb-2 text-[#383A6B] text-sm">Selecciona columnas</h3>
    <div class="flex flex-col gap-2 max-h-60 overflow-y-auto">
        <label *ngFor="let col of columnas" class="flex items-center gap-2 text-sm">
            <input type="checkbox" [(ngModel)]="col.visible" />
            {{ col.label }}
        </label>
    </div>
    <button
        class="mt-4 w-full bg-[#383A6B] text-white rounded py-1 hover:bg-purple-700"
        (click)="showColumnMenu = false"
    >
        Cerrar
    </button>
</div>